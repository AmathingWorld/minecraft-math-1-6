<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft 除法練習場 (RPG版)</title>
    <style>
        /* 1. CSS 樣式 (現代清晰風格與像素化) */
        
        /* 全局設置：使用現代易讀字體，確保清晰度 */
        body {
            font-family: Arial, Helvetica, sans-serif; 
            /* background-color: #F0F0F0; /* 淺灰色背景 */
            color: #333; /* 深色文字 */
            margin: 0;
            padding: 20px;
            text-align: center;
            line-height: 1.6;
            min-height: 100vh;
            
            /* ======== Minecraft 風格背景修正 ======== */
            background-image: url('grass_texture.png'); /* 使用您的草地紋理圖片 */
            background-repeat: repeat; /* 重複平鋪 */
            background-size: 64px 64px; /* 控制紋理大小，使其看起來像素化 */
            background-attachment: fixed; /* 背景不隨滾動條移動 */
            background-color: #557A3A; /* 如果圖片載入失敗，顯示的備用顏色 (Minecraft 草地綠) */
            /* ======================================= */
        }

        /* 移除所有文字陰影，確保清晰度 */
        h1, h2, span, p, button {
            text-shadow: none; 
            letter-spacing: normal;
        }

        /* 核心元素樣式 */
        .block-element {
            border: 1px solid #6B4E3E; /* 稍微深一點的邊框顏色，像木頭或泥土 */
            border-radius: 4px; /* 稍微減少圓角，更方正 */
            padding: 15px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.9); /* 讓區塊有點透明，能看到背景 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* 更明顯的陰影 */
        }

        #game-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: rgba(240, 240, 240, 0.85); /* 遊戲內容區的背景，稍微透明 */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        /* Header */
        header {
            background-color: #3A70CC; /* 像鑽石方塊或天空的藍色 */
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            border-radius: 4px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* 角色圖片區 (像素化修正) */
        #player-avatar {
            width: 50px; 
            height: 50px;
            line-height: 50px;
            background-color: #EEE;
            font-size: 28px; 
            border-radius: 0; /* 方塊/無圓角 */
            border: 2px solid #333;
            padding: 0;
            box-shadow: 2px 2px 0px #000; /* 簡單的方塊陰影 */
            /* 關鍵：強制像素渲染 */
            image-rendering: pixelated;
            -ms-interpolation-mode: nearest-neighbor; 
        }

        /* 經驗和道具顯示區 */
        #stats-box {
            margin-top: 5px; 
            font-size: 14px;
            display: flex;
            gap: 15px;
            justify-content: center;
            background-color: rgba(233, 236, 239, 0.9); /* 稍微透明 */
            color: #333;
            border-radius: 4px;
        }
        .stat-item {
            background-color: #FFF;
            padding: 5px 10px;
            border-radius: 4px;
            color: #333;
            font-weight: bold;
            border: 1px solid #DDD;
        }

        /* 按鈕風格 */
        .block-button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #5CB85C; /* 像綠色羊毛的顏色 */
            color: white;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #4CAE4C; /* 邊框更像方塊 */
            border-radius: 4px; /* 稍微減少圓角 */
            box-shadow: 2px 2px 0px #3A8D3A; /* 像素化陰影 */
            transition: background-color 0.2s, box-shadow 0.1s;
        }
        .block-button:hover, .choice-btn:hover {
            background-color: #4CAE4C;
            box-shadow: 3px 3px 0px #2E702E; /* 陰影變化 */
        }
        .block-button.selected {
            background-color: #FFD700; /* 像金塊 */
            color: #333;
            border-color: #E6B800;
            box-shadow: 2px 2px 0px #CCA700;
        }
        .block-button:disabled {
            background-color: #A9A9A9; /* 灰色石頭 */
            border-color: #8C8C8C;
            cursor: not-allowed;
            box-shadow: 2px 2px 0px #666;
        }
        
        .start-button {
            background-color: #007BFF; /* 更像傳送門的藍色 */
            border-color: #0056B3;
            box-shadow: 2px 2px 0px #004085;
        }
        .start-button:hover {
            background-color: #0056B3;
            box-shadow: 3px 3px 0px #003062;
        }

        /* 問題區 */
        #question-area {
            background-color: #E74C3C; /* 像岩漿或紅石塊的紅色 */
            padding: 30px;
            font-size: 36px;
            font-weight: bold;
            color: white;
            margin: 30px auto;
            border: 2px solid #C0392B;
            border-radius: 4px;
            box-shadow: 3px 3px 0px #A93226;
        }

        /* 選項按鈕區塊 */
        #choices-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background-color: rgba(248, 249, 250, 0.9); /* 稍微透明 */
            border: 1px solid #DDD;
            border-radius: 4px;
        }

        .choice-btn {
            font-size: 22px;
            padding: 15px;
            background-color: #2ECC71; /* 綠色方塊 */
            border-color: #27AE60;
            box-shadow: 2px 2px 0px #219054;
        }
        .choice-btn:hover {
            background-color: #27AE60;
            box-shadow: 3px 3px 0px #1E8449;
        }

        /* 歷史紀錄區 */
        #history-table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #CCC;
            border-radius: 4px;
        }
        #history-table {
            width: 100%;
            border-collapse: collapse;
            background-color: rgba(233, 236, 239, 0.9); /* 稍微透明 */
            margin: 0;
            font-size: 14px;
        }
        #history-table th, #history-table td {
            border: 1px solid #AAA; /* 深一點的邊框 */
            padding: 8px;
            text-align: left;
        }
        #history-table th {
            position: sticky; 
            top: 0;
            background-color: #34495E; /* 深藍色，像青金石 */
            color: white;
            z-index: 10;
        }
        
        .feedback { 
            font-size: 18px; 
            font-weight: bold; 
            margin-top: 10px; 
            background-color: rgba(255, 255, 255, 0.9); /* 確保文字清晰可見 */
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .correct { color: #28A745; }
        .wrong { color: #DC3545; }
        .hidden { display: none; }

    </style>
</head>
<body>

    <header class="block-element">
        <h1>⛏️ Minecraft 除法練習場 🧱</h1>
        <div id="user-profile">
            <span id="player-name">未選擇</span>
            <div id="player-avatar" class="block-element">
                ?
            </div>
        </div>
    </header>
    
    <div id="stats-box" class="block-element">
        <div class="stat-item">經驗值: <span id="current-exp">0</span></div>
        <div class="stat-item">✨ 鑽石: <span id="diamond-count">0</span></div>
        <div class="stat-item">🧱 紅石: <span id="redstone-count">0</span></div>
        <div class="stat-item">⭐ 等級: <span id="current-level">1</span></div>
    </div>
    
    <main id="game-container">
        <section id="selection-screen">
            <h2 class="block-element">選擇你的方塊夥伴</h2>
            <div id="character-selection" class="selection-grid">
                <button class="block-button char-btn" data-char="史帝夫" data-abbr="S" data-img="👤">史帝夫</button>
                <button class="block-button char-btn" data-char="艾力克斯" data-abbr="A" data-img="👩‍🦰">艾力克斯</button>
                <button class="block-button char-btn" data-char="苦力怕" data-abbr="C" data-img="💣">苦力怕</button>
                <button class="block-button char-btn" data-char="骷髏" data-abbr="K" data-img="💀">骷髏</button>
                <button class="block-button char-btn" data-char="貓咪" data-abbr="M" data-img="🐱">貓咪</button>
            </div>

            <h2 class="block-element">選擇練習傳送門 (主題)</h2>
            <div id="topic-selection" class="selection-grid">
                <button class="block-button topic-btn" data-topic-id="basic">紅石基礎電路 (個位數商)</button>
                <button class="block-button topic-btn" data-topic-id="advanced">末地傳送門 (兩位數商)</button>
            </div>
            
            <button id="start-game-btn" class="block-button start-button" disabled>啟動傳送門 (請先選擇)</button>

            <button id="view-history-btn" class="block-button" style="margin-top: 15px; background-color: #6C757D;" disabled>📜 查看角色紀錄</button>
            
            <div id="history-area" class="block-element hidden">
                <h3><span id="history-char-name"></span> 冒險歷史</h3>
                <div id="history-table-container">
                    <table id="history-table">
                        <thead>
                            <tr><th>日期</th><th>主題</th><th>正確題數</th><th>總耗時</th><th>操作</th></tr>
                        </thead>
                        <tbody id="history-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="practice-screen" class="hidden">
            <div id="timer-box" class="block-element">
                總計時: <span id="total-time">0:00</span> | 
                本題計時: <span id="question-time">0:00</span>
                <p>進度: <span id="current-question">0</span>/10</p>
            </div>

            <div id="question-area" class="block-element">
                <p id="division-question">載入中...</p>
            </div>

            <div id="choices-area">
            </div>
            
            <p id="feedback-message" class="feedback">準備好了嗎？</p>
        </section>

        <section id="results-screen" class="hidden">
            <h2 class="block-element">🏆 冒險日誌 (戰利品清單) 🏆</h2>
            <p><strong>角色:</strong> <span id="result-char"></span></p>
            <p><strong>主題:</strong> <span id="result-topic"></span></p>
            <p><strong>總完成時間:</strong> <span id="result-total-time"></span></p>
            <p id="result-message" class="feedback"></p>

            <h3>本次紀錄</h3>
            <table>
                <thead>
                    <tr><th>題號</th><th>算式</th><th>答案</th><th>耗時</th></tr>
                </thead>
                <tbody id="results-table-body"></tbody>
            </table>

            <button id="restart-btn" class="block-button start-button">返回選擇頁面</button>
        </section>
    </main>

    <script>
        // --- 2. JavaScript 邏輯 ---

        // --- 遊戲狀態變數 ---
        let state = {
            selectedChar: null,
            selectedTopic: null,
            currentQuestionIndex: 0,
            questions: [],
            results: [], 
            totalTimer: null,
            questionTimer: null,
            startTime: 0,
            questionStartTime: 0
        };

        // 角色經驗和道具的持續儲存狀態 (確保名稱一致)
        let CHAR_STATS = {
            '史帝夫': { exp: 0, level: 1, diamond: 0, redstone: 0, img: '👤' },
            '艾力克斯': { exp: 0, level: 1, diamond: 0, redstone: 0, img: '👩‍🦰' },
            '苦力怕': { exp: 0, level: 1, diamond: 0, redstone: 0, img: '💣' },
            '骷髏': { exp: 0, level: 1, diamond: 0, redstone: 0, img: '💀' },
            '貓咪': { exp: 0, level: 1, diamond: 0, redstone: 0, img: '🐱' },
        };

        let GAME_HISTORY = [];

        const MAX_QUESTIONS = 10;
        const EXP_PER_QUESTION = 10;
        const BASE_EXP_TO_LEVEL = 100;

        // 道具獎勵設定
        const LOOT_TABLE = [
            { type: 'diamond', min: 1, max: 1, exp: 50, message: "恭喜挖到一顆閃亮的鑽石！" },
            { type: 'redstone', min: 2, max: 5, exp: 10, message: "你找到了一些紅石粉！" },
            { type: 'iron', min: 1, max: 3, exp: 15, message: "獲得了鐵錠，可以打造工具了！" },
            { type: 'exp', min: 20, max: 50, exp: 0, message: "這題完成得真快，獲得額外經驗值！" },
        ];

        const TOPICS = {
            'basic': {
                name: '紅石基礎電路 (個位數商)',
                generate: () => {
                    const quotient = Math.floor(Math.random() * 9) + 1;
                    const divisor = Math.floor(Math.random() * 9) + 1;
                    const dividend = quotient * divisor;
                    return { dividend, divisor, answer: quotient };
                }
            },
            'advanced': {
                name: '末地傳送門 (兩位數商)',
                generate: () => {
                    const quotient = Math.floor(Math.random() * 11) + 10;
                    const divisor = Math.floor(Math.random() * 9) + 1;
                    const dividend = quotient * divisor;
                    return { dividend, divisor, answer: quotient };
                }
            }
        };

        // --- 輔助函數 ---

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // --- RPG/紀錄系統函數 ---

        function loadStats() {
            const savedStats = localStorage.getItem('minecraft_math_stats');
            if (savedStats) {
                const parsedStats = JSON.parse(savedStats);
                for (const char in parsedStats) {
                    if (CHAR_STATS[char]) {
                        CHAR_STATS[char] = { ...CHAR_STATS[char], ...parsedStats[char] };
                    }
                }
            }
            const savedHistory = localStorage.getItem('minecraft_math_history');
            if (savedHistory) {
                GAME_HISTORY = JSON.parse(savedHistory);
            }
        }

        function saveStats() {
            localStorage.setItem('minecraft_math_stats', JSON.stringify(CHAR_STATS));
        }

        function saveHistory() {
            localStorage.setItem('minecraft_math_history', JSON.stringify(GAME_HISTORY));
        }

        function updateStatsDisplay() {
            if (!state.selectedChar) return;
            const stats = CHAR_STATS[state.selectedChar];
            document.getElementById('current-exp').innerText = stats.exp;
            document.getElementById('current-level').innerText = stats.level;
            document.getElementById('diamond-count').innerText = stats.diamond || 0;
            document.getElementById('redstone-count').innerText = stats.redstone || 0;
        }

        function gainExp(amount) {
            const stats = CHAR_STATS[state.selectedChar];
            stats.exp += amount;
            
            let levelUpMessage = '';
            while (stats.exp >= BASE_EXP_TO_LEVEL * stats.level) {
                stats.exp -= BASE_EXP_TO_LEVEL * stats.level; 
                stats.level++;
                levelUpMessage += `\n🚀 ${state.selectedChar} 升級到等級 ${stats.level} 了！`;
            }
            updateStatsDisplay();
            saveStats();
            return levelUpMessage;
        }

        function giveLoot(isCorrect) {
            if (!isCorrect) return;
            let feedbackText = '';

            const baseExpMessage = gainExp(EXP_PER_QUESTION);
            feedbackText += `\n獲得 ${EXP_PER_QUESTION} 點經驗值。${baseExpMessage}`;

            const lootIndex = Math.floor(Math.random() * LOOT_TABLE.length);
            const loot = LOOT_TABLE[lootIndex];
            const amount = Math.floor(Math.random() * (loot.max - loot.min + 1)) + loot.min;

            if (loot.type === 'exp') {
                gainExp(amount);
                feedbackText += `\n✨ ${loot.message} (額外 +${amount} EXP)`;
            } else {
                if (CHAR_STATS[state.selectedChar][loot.type] === undefined) {
                    CHAR_STATS[state.selectedChar][loot.type] = 0;
                }
                
                CHAR_STATS[state.selectedChar][loot.type] += amount;
                gainExp(loot.exp);
                feedbackText += `\n🎁 ${loot.message} (獲得 ${amount} 個)`;
            }
            
            document.getElementById('feedback-message').innerText += feedbackText;
            updateStatsDisplay();
            saveStats();
        }

        /** 顯示選定角色的歷史紀錄 */
        function displayHistory(characterName) {
            const historyBody = document.getElementById('history-table-body');
            const historyArea = document.getElementById('history-area');
            
            const filteredHistory = GAME_HISTORY.filter(record => record.char === characterName);

            document.getElementById('history-char-name').innerText = characterName;
            historyBody.innerHTML = '';
            
            if (filteredHistory.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="5">尚無紀錄，快去探險吧！</td></tr>';
            } else {
                filteredHistory.slice().reverse().forEach((record) => {
                    const originalIndex = GAME_HISTORY.findIndex(r => 
                        r.char === record.char && 
                        r.date === record.date && 
                        r.time === record.time);
                    
                    if (originalIndex === -1) return; 

                    const row = historyBody.insertRow();
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.topic}</td>
                        <td>${record.correct}/${MAX_QUESTIONS}</td>
                        <td>${formatTime(record.time)}</td>
                        <td><button class="block-button" style="padding: 5px 10px; font-size: 12px; background-color: #007bff;" onclick="toggleDetails(${originalIndex})">
                            ${record.detailsVisible ? '▲ 隱藏' : '▼ 詳情'}
                        </button></td>
                    `;

                    const detailRow = historyBody.insertRow();
                    detailRow.id = `details-row-${originalIndex}`;
                    detailRow.style.display = record.detailsVisible ? 'table-row' : 'none';
                    
                    const detailsContent = record.details && record.details.length > 0 ? record.details.map((r, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${r.question}</td>
                            <td>${r.answer}</td>
                            <td>${formatTime(r.time)}</td>
                        </tr>
                    `).join('') : '<tr><td colspan="4">無詳細作答記錄</td></tr>';
                    
                    detailRow.innerHTML = `<td colspan="5">
                        <div style="max-height: 200px; overflow-y: auto; background: #f0f0f0; padding: 10px; border-radius: 4px;">
                            <table style="width: 100%; font-size: 12px;">
                                <thead>
                                    <tr><th>題號</th><th>算式</th><th>正確答案</th><th>耗時</th></tr>
                                </thead>
                                <tbody>
                                    ${detailsContent}
                                </tbody>
                            </table>
                        </div>
                    </td>`;
                });
            }

            historyArea.classList.remove('hidden');
        }

        /** 切換單次歷史紀錄的詳細內容 */
        window.toggleDetails = function(originalIndex) {
            const record = GAME_HISTORY[originalIndex];
            if (record) {
                record.detailsVisible = !record.detailsVisible;
                saveHistory(); 
                displayHistory(state.selectedChar); 
            }
        }


        // --- 遊戲核心函數 ---

        function checkReady() {
            const startBtn = document.getElementById('start-game-btn');
            const historyBtn = document.getElementById('view-history-btn');
            
            if (state.selectedChar && state.selectedTopic) {
                startBtn.disabled = false;
                startBtn.innerText = '啟動傳送門！';
            } else {
                startBtn.disabled = true;
                startBtn.innerText = '啟動傳送門 (請先選擇)';
            }

            if (state.selectedChar) {
                historyBtn.disabled = false;
            } else {
                historyBtn.disabled = true;
            }
            
            document.getElementById('history-area').classList.add('hidden');
        }
                
        function startGame() {
            state.currentQuestionIndex = 0;
            state.results = [];
            
            generateQuestions(); 
            
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('practice-screen').classList.remove('hidden');

            showNextQuestion();
            startTimers();
        }

        function generateQuestions() {
            state.questions = [];
            if (!state.selectedTopic || !TOPICS[state.selectedTopic]) {
                console.error("錯誤: 主題未選定或無效");
                return;
            }
            for (let i = 0; i < MAX_QUESTIONS; i++) {
                state.questions.push(TOPICS[state.selectedTopic].generate());
            }
        }
                
        function generateChoices(correctAnswer) { 
            const choices = new Set([correctAnswer]);
            const minAnswer = 1;
            const maxAnswer = 20;
            
            while (choices.size < 4) {
                let fakeAnswer;
                let range = 3; 
                fakeAnswer = Math.floor(Math.random() * (2 * range + 1)) + (correctAnswer - range);
                
                if (fakeAnswer >= minAnswer && fakeAnswer <= maxAnswer && !choices.has(fakeAnswer)) {
                    choices.add(fakeAnswer);
                }
            }
            return Array.from(choices).sort(() => Math.random() - 0.5);
        }

        function showNextQuestion() {
            if (state.currentQuestionIndex >= MAX_QUESTIONS) {
                showResultsScreen();
                return;
            }
            
            const q = state.questions[state.currentQuestionIndex];
            if (!q) {
                console.error("錯誤：無法找到當前題目，可能是 generateQuestions 失敗。");
                document.getElementById('division-question').innerText = "載入題目失敗，請重試。";
                return;
            }

            document.getElementById('division-question').innerText = `${q.dividend} ÷ ${q.divisor} = ?`;
            document.getElementById('current-question').innerText = state.currentQuestionIndex + 1;
            document.getElementById('feedback-message').innerText = '準備好了嗎？';
            document.getElementById('feedback-message').className = 'feedback';
            
            const choices = generateChoices(q.answer);
            const choicesArea = document.getElementById('choices-area');
            choicesArea.innerHTML = '';

            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn block-button';
                button.innerText = choice;
                button.addEventListener('click', () => handleChoice(choice));
                choicesArea.appendChild(button);
            });
            
            startQuestionTimer();
        }

        function handleChoice(chosenAnswer) {
            document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
            
            const q = state.questions[state.currentQuestionIndex];
            const feedback = document.getElementById('feedback-message');
            const correctAnswer = q.answer;

            if (chosenAnswer === correctAnswer) {
                clearInterval(state.questionTimer);
                const questionTimeElapsed = Date.now() - state.questionStartTime;

                feedback.innerText = "✅ 正確！正在發放獎勵...";
                feedback.className = 'feedback correct';
                
                giveLoot(true); 
                
                state.results.push({
                    question: `${q.dividend} ÷ ${q.divisor}`,
                    answer: correctAnswer,
                    chosen: chosenAnswer,
                    time: questionTimeElapsed,
                    isCorrect: true 
                });

                state.currentQuestionIndex++;
                
                setTimeout(showNextQuestion, 2000); 
            } else {
                state.results.push({
                    question: `${q.dividend} ÷ ${q.divisor}`,
                    answer: correctAnswer,
                    chosen: chosenAnswer,
                    time: Date.now() - state.questionStartTime,
                    isCorrect: false 
                });

                feedback.innerText = "❌ 錯誤！請重新選擇。";
                feedback.className = 'feedback wrong';
                
                document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = false);
            }
        }

        function showResultsScreen() {
            stopTimers();
            const totalTimeElapsed = Date.now() - state.startTime;
            
            const correctResults = state.results.filter(r => r.isCorrect === true);
            const totalCorrect = correctResults.length; 

            GAME_HISTORY.push({
                char: state.selectedChar,
                date: new Date().toLocaleDateString('zh-TW'),
                topic: TOPICS[state.selectedTopic].name,
                correct: totalCorrect,
                time: totalTimeElapsed,
                details: correctResults, 
                detailsVisible: false 
            });
            saveHistory();

            document.getElementById('practice-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');

            document.getElementById('result-char').innerText = state.selectedChar;
            document.getElementById('result-topic').innerText = TOPICS[state.selectedTopic].name;
            document.getElementById('result-total-time').innerText = formatTime(totalTimeElapsed);

            const avgTime = (totalTimeElapsed / 1000) / (totalCorrect || 1); 
            let message = "";
            if (totalCorrect < MAX_QUESTIONS) {
                message = "☠️ 挑戰失敗！苦力怕爆炸了！下次專心點！";
            } else if (avgTime < 10) {
                message = "🔥 你簡直是**指令方塊**！速度太快了！";
            } else if (avgTime < 20) {
                message = "⛏️ 這次挖掘收穫不錯！繼續努力！";
            } else {
                message = "🐢 像在**下界**移動一樣慢... 專注點，下次一定可以更快！";
            }
            document.getElementById('result-message').innerText = message;

            const tableBody = document.getElementById('results-table-body');
            tableBody.innerHTML = '';
            correctResults.forEach((r, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).innerText = index + 1;
                row.insertCell(1).innerText = r.question;
                row.insertCell(2).innerText = r.answer;
                row.insertCell(3).innerText = formatTime(r.time);
            });
        }

        function startTimers() {
            state.startTime = Date.now();
            state.totalTimer = setInterval(() => {
                document.getElementById('total-time').innerText = formatTime(Date.now() - state.startTime);
            }, 1000);
            startQuestionTimer();
        }

        function stopTimers() {
            clearInterval(state.totalTimer);
            clearInterval(state.questionTimer);
        }

        function startQuestionTimer() {
            state.questionStartTime = Date.now();
            clearInterval(state.questionTimer);
            state.questionTimer = setInterval(() => {
                document.getElementById('question-time').innerText = formatTime(Date.now() - state.questionStartTime);
            }, 100);
        }


        // --- 事件監聽器設定 ---

        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            updateStatsDisplay(); 
            checkReady(); 

            document.querySelectorAll('.char-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.char-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    
                    state.selectedChar = e.target.dataset.char;
                    
                    document.getElementById('player-name').innerText = state.selectedChar;
                    document.getElementById('player-avatar').innerText = e.target.dataset.img;
                    
                    updateStatsDisplay(); 
                    checkReady(); 
                });
            });

            document.querySelectorAll('.topic-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.topic-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');

                    state.selectedTopic = e.target.dataset.topicId;
                    checkReady(); 
                });
            });

            document.getElementById('start-game-btn').addEventListener('click', startGame);
            
            document.getElementById('view-history-btn').addEventListener('click', () => {
                const historyArea = document.getElementById('history-area');
                if (historyArea.classList.contains('hidden')) {
                    displayHistory(state.selectedChar);
                } else {
                    historyArea.classList.add('hidden');
                }
            });

            document.getElementById('restart-btn').addEventListener('click', () => {
                document.getElementById('results-screen').classList.add('hidden');
                document.getElementById('selection-screen').classList.remove('hidden');
                
                state.selectedChar = null;
                state.selectedTopic = null;
                
                document.getElementById('player-name').innerText = '未選擇';
                document.querySelectorAll('.block-button').forEach(btn => btn.classList.remove('selected'));
                document.getElementById('player-avatar').innerText = '?'; // 重設頭像
                
                checkReady(); 
            });
        });
    </script>
</body>
</html>