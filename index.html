<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft é™¤æ³•ç·´ç¿’å ´ (RPGç‰ˆ)</title>
    <style>
        /* 1. CSS æ¨£å¼ (ç¾ä»£æ¸…æ™°é¢¨æ ¼èˆ‡åƒç´ åŒ–) */
        
        /* å…¨å±€è¨­ç½®ï¼šä½¿ç”¨ç¾ä»£æ˜“è®€å­—é«”ï¼Œç¢ºä¿æ¸…æ™°åº¦ */
        body {
            font-family: Arial, Helvetica, sans-serif; 
            /* background-color: #F0F0F0; /* æ·ºç°è‰²èƒŒæ™¯ */
            color: #333; /* æ·±è‰²æ–‡å­— */
            margin: 0;
            padding: 20px;
            text-align: center;
            line-height: 1.6;
            min-height: 100vh;
            
            /* ======== Minecraft é¢¨æ ¼èƒŒæ™¯ä¿®æ­£ ======== */
            background-image: url('grass_texture.png'); /* ä½¿ç”¨æ‚¨çš„è‰åœ°ç´‹ç†åœ–ç‰‡ */
            background-repeat: repeat; /* é‡è¤‡å¹³é‹ª */
            background-size: 64px 64px; /* æ§åˆ¶ç´‹ç†å¤§å°ï¼Œä½¿å…¶çœ‹èµ·ä¾†åƒç´ åŒ– */
            background-attachment: fixed; /* èƒŒæ™¯ä¸éš¨æ»¾å‹•æ¢ç§»å‹• */
            background-color: #557A3A; /* å¦‚æœåœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºçš„å‚™ç”¨é¡è‰² (Minecraft è‰åœ°ç¶ ) */
            /* ======================================= */
        }

        /* ç§»é™¤æ‰€æœ‰æ–‡å­—é™°å½±ï¼Œç¢ºä¿æ¸…æ™°åº¦ */
        h1, h2, span, p, button {
            text-shadow: none; 
            letter-spacing: normal;
        }

        /* æ ¸å¿ƒå…ƒç´ æ¨£å¼ */
        .block-element {
            border: 1px solid #6B4E3E; /* ç¨å¾®æ·±ä¸€é»çš„é‚Šæ¡†é¡è‰²ï¼Œåƒæœ¨é ­æˆ–æ³¥åœŸ */
            border-radius: 4px; /* ç¨å¾®æ¸›å°‘åœ“è§’ï¼Œæ›´æ–¹æ­£ */
            padding: 15px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.9); /* è®“å€å¡Šæœ‰é»é€æ˜ï¼Œèƒ½çœ‹åˆ°èƒŒæ™¯ */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* æ›´æ˜é¡¯çš„é™°å½± */
        }

        #game-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: rgba(240, 240, 240, 0.85); /* éŠæˆ²å…§å®¹å€çš„èƒŒæ™¯ï¼Œç¨å¾®é€æ˜ */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        /* Header */
        header {
            background-color: #3A70CC; /* åƒé‘½çŸ³æ–¹å¡Šæˆ–å¤©ç©ºçš„è—è‰² */
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            border-radius: 4px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* è§’è‰²åœ–ç‰‡å€ (åƒç´ åŒ–ä¿®æ­£) */
        #player-avatar {
            width: 50px; 
            height: 50px;
            line-height: 50px;
            background-color: #EEE;
            font-size: 28px; 
            border-radius: 0; /* æ–¹å¡Š/ç„¡åœ“è§’ */
            border: 2px solid #333;
            padding: 0;
            box-shadow: 2px 2px 0px #000; /* ç°¡å–®çš„æ–¹å¡Šé™°å½± */
            /* é—œéµï¼šå¼·åˆ¶åƒç´ æ¸²æŸ“ */
            image-rendering: pixelated;
            -ms-interpolation-mode: nearest-neighbor; 
        }

        /* ç¶“é©—å’Œé“å…·é¡¯ç¤ºå€ */
        #stats-box {
            margin-top: 5px; 
            font-size: 14px;
            display: flex;
            gap: 15px;
            justify-content: center;
            background-color: rgba(233, 236, 239, 0.9); /* ç¨å¾®é€æ˜ */
            color: #333;
            border-radius: 4px;
        }
        .stat-item {
            background-color: #FFF;
            padding: 5px 10px;
            border-radius: 4px;
            color: #333;
            font-weight: bold;
            border: 1px solid #DDD;
        }

        /* æŒ‰éˆ•é¢¨æ ¼ */
        .block-button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #5CB85C; /* åƒç¶ è‰²ç¾Šæ¯›çš„é¡è‰² */
            color: white;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #4CAE4C; /* é‚Šæ¡†æ›´åƒæ–¹å¡Š */
            border-radius: 4px; /* ç¨å¾®æ¸›å°‘åœ“è§’ */
            box-shadow: 2px 2px 0px #3A8D3A; /* åƒç´ åŒ–é™°å½± */
            transition: background-color 0.2s, box-shadow 0.1s;
        }
        .block-button:hover, .choice-btn:hover {
            background-color: #4CAE4C;
            box-shadow: 3px 3px 0px #2E702E; /* é™°å½±è®ŠåŒ– */
        }
        .block-button.selected {
            background-color: #FFD700; /* åƒé‡‘å¡Š */
            color: #333;
            border-color: #E6B800;
            box-shadow: 2px 2px 0px #CCA700;
        }
        .block-button:disabled {
            background-color: #A9A9A9; /* ç°è‰²çŸ³é ­ */
            border-color: #8C8C8C;
            cursor: not-allowed;
            box-shadow: 2px 2px 0px #666;
        }
        
        .start-button {
            background-color: #007BFF; /* æ›´åƒå‚³é€é–€çš„è—è‰² */
            border-color: #0056B3;
            box-shadow: 2px 2px 0px #004085;
        }
        .start-button:hover {
            background-color: #0056B3;
            box-shadow: 3px 3px 0px #003062;
        }

        /* å•é¡Œå€ */
        #question-area {
            background-color: #E74C3C; /* åƒå²©æ¼¿æˆ–ç´…çŸ³å¡Šçš„ç´…è‰² */
            padding: 30px;
            font-size: 36px;
            font-weight: bold;
            color: white;
            margin: 30px auto;
            border: 2px solid #C0392B;
            border-radius: 4px;
            box-shadow: 3px 3px 0px #A93226;
        }

        /* é¸é …æŒ‰éˆ•å€å¡Š */
        #choices-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background-color: rgba(248, 249, 250, 0.9); /* ç¨å¾®é€æ˜ */
            border: 1px solid #DDD;
            border-radius: 4px;
        }

        .choice-btn {
            font-size: 22px;
            padding: 15px;
            background-color: #2ECC71; /* ç¶ è‰²æ–¹å¡Š */
            border-color: #27AE60;
            box-shadow: 2px 2px 0px #219054;
        }
        .choice-btn:hover {
            background-color: #27AE60;
            box-shadow: 3px 3px 0px #1E8449;
        }

        /* æ­·å²ç´€éŒ„å€ */
        #history-table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #CCC;
            border-radius: 4px;
        }
        #history-table {
            width: 100%;
            border-collapse: collapse;
            background-color: rgba(233, 236, 239, 0.9); /* ç¨å¾®é€æ˜ */
            margin: 0;
            font-size: 14px;
        }
        #history-table th, #history-table td {
            border: 1px solid #AAA; /* æ·±ä¸€é»çš„é‚Šæ¡† */
            padding: 8px;
            text-align: left;
        }
        #history-table th {
            position: sticky; 
            top: 0;
            background-color: #34495E; /* æ·±è—è‰²ï¼Œåƒé’é‡‘çŸ³ */
            color: white;
            z-index: 10;
        }
        
        .feedback { 
            font-size: 18px; 
            font-weight: bold; 
            margin-top: 10px; 
            background-color: rgba(255, 255, 255, 0.9); /* ç¢ºä¿æ–‡å­—æ¸…æ™°å¯è¦‹ */
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .correct { color: #28A745; }
        .wrong { color: #DC3545; }
        .hidden { display: none; }

    </style>
</head>
<body>

    <header class="block-element">
        <h1>â›ï¸ Minecraft é™¤æ³•ç·´ç¿’å ´ ğŸ§±</h1>
        <div id="user-profile">
            <span id="player-name">æœªé¸æ“‡</span>
            <div id="player-avatar" class="block-element">
                ?
            </div>
        </div>
    </header>
    
    <div id="stats-box" class="block-element">
        <div class="stat-item">ç¶“é©—å€¼: <span id="current-exp">0</span></div>
        <div class="stat-item">âœ¨ é‘½çŸ³: <span id="diamond-count">0</span></div>
        <div class="stat-item">ğŸ§± ç´…çŸ³: <span id="redstone-count">0</span></div>
        <div class="stat-item">â­ ç­‰ç´š: <span id="current-level">1</span></div>
    </div>
    
    <main id="game-container">
        <section id="selection-screen">
            <h2 class="block-element">é¸æ“‡ä½ çš„æ–¹å¡Šå¤¥ä¼´</h2>
            <div id="character-selection" class="selection-grid">
                <button class="block-button char-btn" data-char="å²å¸å¤«" data-abbr="S" data-img="ğŸ‘¤">å²å¸å¤«</button>
                <button class="block-button char-btn" data-char="è‰¾åŠ›å…‹æ–¯" data-abbr="A" data-img="ğŸ‘©â€ğŸ¦°">è‰¾åŠ›å…‹æ–¯</button>
                <button class="block-button char-btn" data-char="è‹¦åŠ›æ€•" data-abbr="C" data-img="ğŸ’£">è‹¦åŠ›æ€•</button>
                <button class="block-button char-btn" data-char="éª·é«" data-abbr="K" data-img="ğŸ’€">éª·é«</button>
                <button class="block-button char-btn" data-char="è²“å’ª" data-abbr="M" data-img="ğŸ±">è²“å’ª</button>
            </div>

            <h2 class="block-element">é¸æ“‡ç·´ç¿’å‚³é€é–€ (ä¸»é¡Œ)</h2>
            <div id="topic-selection" class="selection-grid">
                <button class="block-button topic-btn" data-topic-id="basic">ç´…çŸ³åŸºç¤é›»è·¯ (å€‹ä½æ•¸å•†)</button>
                <button class="block-button topic-btn" data-topic-id="advanced">æœ«åœ°å‚³é€é–€ (å…©ä½æ•¸å•†)</button>
            </div>
            
            <button id="start-game-btn" class="block-button start-button" disabled>å•Ÿå‹•å‚³é€é–€ (è«‹å…ˆé¸æ“‡)</button>

            <button id="view-history-btn" class="block-button" style="margin-top: 15px; background-color: #6C757D;" disabled>ğŸ“œ æŸ¥çœ‹è§’è‰²ç´€éŒ„</button>
            
            <div id="history-area" class="block-element hidden">
                <h3><span id="history-char-name"></span> å†’éšªæ­·å²</h3>
                <div id="history-table-container">
                    <table id="history-table">
                        <thead>
                            <tr><th>æ—¥æœŸ</th><th>ä¸»é¡Œ</th><th>æ­£ç¢ºé¡Œæ•¸</th><th>ç¸½è€—æ™‚</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody id="history-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="practice-screen" class="hidden">
            <div id="timer-box" class="block-element">
                ç¸½è¨ˆæ™‚: <span id="total-time">0:00</span> | 
                æœ¬é¡Œè¨ˆæ™‚: <span id="question-time">0:00</span>
                <p>é€²åº¦: <span id="current-question">0</span>/10</p>
            </div>

            <div id="question-area" class="block-element">
                <p id="division-question">è¼‰å…¥ä¸­...</p>
            </div>

            <div id="choices-area">
            </div>
            
            <p id="feedback-message" class="feedback">æº–å‚™å¥½äº†å—ï¼Ÿ</p>
        </section>

        <section id="results-screen" class="hidden">
            <h2 class="block-element">ğŸ† å†’éšªæ—¥èªŒ (æˆ°åˆ©å“æ¸…å–®) ğŸ†</h2>
            <p><strong>è§’è‰²:</strong> <span id="result-char"></span></p>
            <p><strong>ä¸»é¡Œ:</strong> <span id="result-topic"></span></p>
            <p><strong>ç¸½å®Œæˆæ™‚é–“:</strong> <span id="result-total-time"></span></p>
            <p id="result-message" class="feedback"></p>

            <h3>æœ¬æ¬¡ç´€éŒ„</h3>
            <table>
                <thead>
                    <tr><th>é¡Œè™Ÿ</th><th>ç®—å¼</th><th>ç­”æ¡ˆ</th><th>è€—æ™‚</th></tr>
                </thead>
                <tbody id="results-table-body"></tbody>
            </table>

            <button id="restart-btn" class="block-button start-button">è¿”å›é¸æ“‡é é¢</button>
        </section>
    </main>

    <script>
        // --- 2. JavaScript é‚è¼¯ ---

        // --- éŠæˆ²ç‹€æ…‹è®Šæ•¸ ---
        let state = {
            selectedChar: null,
            selectedTopic: null,
            currentQuestionIndex: 0,
            questions: [],
            results: [], 
            totalTimer: null,
            questionTimer: null,
            startTime: 0,
            questionStartTime: 0
        };

        // è§’è‰²ç¶“é©—å’Œé“å…·çš„æŒçºŒå„²å­˜ç‹€æ…‹ (ç¢ºä¿åç¨±ä¸€è‡´)
        let CHAR_STATS = {
            'å²å¸å¤«': { exp: 0, level: 1, diamond: 0, redstone: 0, img: 'ğŸ‘¤' },
            'è‰¾åŠ›å…‹æ–¯': { exp: 0, level: 1, diamond: 0, redstone: 0, img: 'ğŸ‘©â€ğŸ¦°' },
            'è‹¦åŠ›æ€•': { exp: 0, level: 1, diamond: 0, redstone: 0, img: 'ğŸ’£' },
            'éª·é«': { exp: 0, level: 1, diamond: 0, redstone: 0, img: 'ğŸ’€' },
            'è²“å’ª': { exp: 0, level: 1, diamond: 0, redstone: 0, img: 'ğŸ±' },
        };

        let GAME_HISTORY = [];

        const MAX_QUESTIONS = 10;
        const EXP_PER_QUESTION = 10;
        const BASE_EXP_TO_LEVEL = 100;

        // é“å…·çå‹µè¨­å®š
        const LOOT_TABLE = [
            { type: 'diamond', min: 1, max: 1, exp: 50, message: "æ­å–œæŒ–åˆ°ä¸€é¡†é–ƒäº®çš„é‘½çŸ³ï¼" },
            { type: 'redstone', min: 2, max: 5, exp: 10, message: "ä½ æ‰¾åˆ°äº†ä¸€äº›ç´…çŸ³ç²‰ï¼" },
            { type: 'iron', min: 1, max: 3, exp: 15, message: "ç²å¾—äº†éµéŒ ï¼Œå¯ä»¥æ‰“é€ å·¥å…·äº†ï¼" },
            { type: 'exp', min: 20, max: 50, exp: 0, message: "é€™é¡Œå®Œæˆå¾—çœŸå¿«ï¼Œç²å¾—é¡å¤–ç¶“é©—å€¼ï¼" },
        ];

        const TOPICS = {
            'basic': {
                name: 'ç´…çŸ³åŸºç¤é›»è·¯ (å€‹ä½æ•¸å•†)',
                generate: () => {
                    const quotient = Math.floor(Math.random() * 9) + 1;
                    const divisor = Math.floor(Math.random() * 9) + 1;
                    const dividend = quotient * divisor;
                    return { dividend, divisor, answer: quotient };
                }
            },
            'advanced': {
                name: 'æœ«åœ°å‚³é€é–€ (å…©ä½æ•¸å•†)',
                generate: () => {
                    const quotient = Math.floor(Math.random() * 11) + 10;
                    const divisor = Math.floor(Math.random() * 9) + 1;
                    const dividend = quotient * divisor;
                    return { dividend, divisor, answer: quotient };
                }
            }
        };

        // --- è¼”åŠ©å‡½æ•¸ ---

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // --- RPG/ç´€éŒ„ç³»çµ±å‡½æ•¸ ---

        function loadStats() {
            const savedStats = localStorage.getItem('minecraft_math_stats');
            if (savedStats) {
                const parsedStats = JSON.parse(savedStats);
                for (const char in parsedStats) {
                    if (CHAR_STATS[char]) {
                        CHAR_STATS[char] = { ...CHAR_STATS[char], ...parsedStats[char] };
                    }
                }
            }
            const savedHistory = localStorage.getItem('minecraft_math_history');
            if (savedHistory) {
                GAME_HISTORY = JSON.parse(savedHistory);
            }
        }

        function saveStats() {
            localStorage.setItem('minecraft_math_stats', JSON.stringify(CHAR_STATS));
        }

        function saveHistory() {
            localStorage.setItem('minecraft_math_history', JSON.stringify(GAME_HISTORY));
        }

        function updateStatsDisplay() {
            if (!state.selectedChar) return;
            const stats = CHAR_STATS[state.selectedChar];
            document.getElementById('current-exp').innerText = stats.exp;
            document.getElementById('current-level').innerText = stats.level;
            document.getElementById('diamond-count').innerText = stats.diamond || 0;
            document.getElementById('redstone-count').innerText = stats.redstone || 0;
        }

        function gainExp(amount) {
            const stats = CHAR_STATS[state.selectedChar];
            stats.exp += amount;
            
            let levelUpMessage = '';
            while (stats.exp >= BASE_EXP_TO_LEVEL * stats.level) {
                stats.exp -= BASE_EXP_TO_LEVEL * stats.level; 
                stats.level++;
                levelUpMessage += `\nğŸš€ ${state.selectedChar} å‡ç´šåˆ°ç­‰ç´š ${stats.level} äº†ï¼`;
            }
            updateStatsDisplay();
            saveStats();
            return levelUpMessage;
        }

        function giveLoot(isCorrect) {
            if (!isCorrect) return;
            let feedbackText = '';

            const baseExpMessage = gainExp(EXP_PER_QUESTION);
            feedbackText += `\nç²å¾— ${EXP_PER_QUESTION} é»ç¶“é©—å€¼ã€‚${baseExpMessage}`;

            const lootIndex = Math.floor(Math.random() * LOOT_TABLE.length);
            const loot = LOOT_TABLE[lootIndex];
            const amount = Math.floor(Math.random() * (loot.max - loot.min + 1)) + loot.min;

            if (loot.type === 'exp') {
                gainExp(amount);
                feedbackText += `\nâœ¨ ${loot.message} (é¡å¤– +${amount} EXP)`;
            } else {
                if (CHAR_STATS[state.selectedChar][loot.type] === undefined) {
                    CHAR_STATS[state.selectedChar][loot.type] = 0;
                }
                
                CHAR_STATS[state.selectedChar][loot.type] += amount;
                gainExp(loot.exp);
                feedbackText += `\nğŸ ${loot.message} (ç²å¾— ${amount} å€‹)`;
            }
            
            document.getElementById('feedback-message').innerText += feedbackText;
            updateStatsDisplay();
            saveStats();
        }

        /** é¡¯ç¤ºé¸å®šè§’è‰²çš„æ­·å²ç´€éŒ„ */
        function displayHistory(characterName) {
            const historyBody = document.getElementById('history-table-body');
            const historyArea = document.getElementById('history-area');
            
            const filteredHistory = GAME_HISTORY.filter(record => record.char === characterName);

            document.getElementById('history-char-name').innerText = characterName;
            historyBody.innerHTML = '';
            
            if (filteredHistory.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="5">å°šç„¡ç´€éŒ„ï¼Œå¿«å»æ¢éšªå§ï¼</td></tr>';
            } else {
                filteredHistory.slice().reverse().forEach((record) => {
                    const originalIndex = GAME_HISTORY.findIndex(r => 
                        r.char === record.char && 
                        r.date === record.date && 
                        r.time === record.time);
                    
                    if (originalIndex === -1) return; 

                    const row = historyBody.insertRow();
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.topic}</td>
                        <td>${record.correct}/${MAX_QUESTIONS}</td>
                        <td>${formatTime(record.time)}</td>
                        <td><button class="block-button" style="padding: 5px 10px; font-size: 12px; background-color: #007bff;" onclick="toggleDetails(${originalIndex})">
                            ${record.detailsVisible ? 'â–² éš±è—' : 'â–¼ è©³æƒ…'}
                        </button></td>
                    `;

                    const detailRow = historyBody.insertRow();
                    detailRow.id = `details-row-${originalIndex}`;
                    detailRow.style.display = record.detailsVisible ? 'table-row' : 'none';
                    
                    const detailsContent = record.details && record.details.length > 0 ? record.details.map((r, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${r.question}</td>
                            <td>${r.answer}</td>
                            <td>${formatTime(r.time)}</td>
                        </tr>
                    `).join('') : '<tr><td colspan="4">ç„¡è©³ç´°ä½œç­”è¨˜éŒ„</td></tr>';
                    
                    detailRow.innerHTML = `<td colspan="5">
                        <div style="max-height: 200px; overflow-y: auto; background: #f0f0f0; padding: 10px; border-radius: 4px;">
                            <table style="width: 100%; font-size: 12px;">
                                <thead>
                                    <tr><th>é¡Œè™Ÿ</th><th>ç®—å¼</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>è€—æ™‚</th></tr>
                                </thead>
                                <tbody>
                                    ${detailsContent}
                                </tbody>
                            </table>
                        </div>
                    </td>`;
                });
            }

            historyArea.classList.remove('hidden');
        }

        /** åˆ‡æ›å–®æ¬¡æ­·å²ç´€éŒ„çš„è©³ç´°å…§å®¹ */
        window.toggleDetails = function(originalIndex) {
            const record = GAME_HISTORY[originalIndex];
            if (record) {
                record.detailsVisible = !record.detailsVisible;
                saveHistory(); 
                displayHistory(state.selectedChar); 
            }
        }


        // --- éŠæˆ²æ ¸å¿ƒå‡½æ•¸ ---

        function checkReady() {
            const startBtn = document.getElementById('start-game-btn');
            const historyBtn = document.getElementById('view-history-btn');
            
            if (state.selectedChar && state.selectedTopic) {
                startBtn.disabled = false;
                startBtn.innerText = 'å•Ÿå‹•å‚³é€é–€ï¼';
            } else {
                startBtn.disabled = true;
                startBtn.innerText = 'å•Ÿå‹•å‚³é€é–€ (è«‹å…ˆé¸æ“‡)';
            }

            if (state.selectedChar) {
                historyBtn.disabled = false;
            } else {
                historyBtn.disabled = true;
            }
            
            document.getElementById('history-area').classList.add('hidden');
        }
                
        function startGame() {
            state.currentQuestionIndex = 0;
            state.results = [];
            
            generateQuestions(); 
            
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('practice-screen').classList.remove('hidden');

            showNextQuestion();
            startTimers();
        }

        function generateQuestions() {
            state.questions = [];
            if (!state.selectedTopic || !TOPICS[state.selectedTopic]) {
                console.error("éŒ¯èª¤: ä¸»é¡Œæœªé¸å®šæˆ–ç„¡æ•ˆ");
                return;
            }
            for (let i = 0; i < MAX_QUESTIONS; i++) {
                state.questions.push(TOPICS[state.selectedTopic].generate());
            }
        }
                
        function generateChoices(correctAnswer) { 
            const choices = new Set([correctAnswer]);
            const minAnswer = 1;
            const maxAnswer = 20;
            
            while (choices.size < 4) {
                let fakeAnswer;
                let range = 3; 
                fakeAnswer = Math.floor(Math.random() * (2 * range + 1)) + (correctAnswer - range);
                
                if (fakeAnswer >= minAnswer && fakeAnswer <= maxAnswer && !choices.has(fakeAnswer)) {
                    choices.add(fakeAnswer);
                }
            }
            return Array.from(choices).sort(() => Math.random() - 0.5);
        }

        function showNextQuestion() {
            if (state.currentQuestionIndex >= MAX_QUESTIONS) {
                showResultsScreen();
                return;
            }
            
            const q = state.questions[state.currentQuestionIndex];
            if (!q) {
                console.error("éŒ¯èª¤ï¼šç„¡æ³•æ‰¾åˆ°ç•¶å‰é¡Œç›®ï¼Œå¯èƒ½æ˜¯ generateQuestions å¤±æ•—ã€‚");
                document.getElementById('division-question').innerText = "è¼‰å…¥é¡Œç›®å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚";
                return;
            }

            document.getElementById('division-question').innerText = `${q.dividend} Ã· ${q.divisor} = ?`;
            document.getElementById('current-question').innerText = state.currentQuestionIndex + 1;
            document.getElementById('feedback-message').innerText = 'æº–å‚™å¥½äº†å—ï¼Ÿ';
            document.getElementById('feedback-message').className = 'feedback';
            
            const choices = generateChoices(q.answer);
            const choicesArea = document.getElementById('choices-area');
            choicesArea.innerHTML = '';

            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn block-button';
                button.innerText = choice;
                button.addEventListener('click', () => handleChoice(choice));
                choicesArea.appendChild(button);
            });
            
            startQuestionTimer();
        }

        function handleChoice(chosenAnswer) {
            document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
            
            const q = state.questions[state.currentQuestionIndex];
            const feedback = document.getElementById('feedback-message');
            const correctAnswer = q.answer;

            if (chosenAnswer === correctAnswer) {
                clearInterval(state.questionTimer);
                const questionTimeElapsed = Date.now() - state.questionStartTime;

                feedback.innerText = "âœ… æ­£ç¢ºï¼æ­£åœ¨ç™¼æ”¾çå‹µ...";
                feedback.className = 'feedback correct';
                
                giveLoot(true); 
                
                state.results.push({
                    question: `${q.dividend} Ã· ${q.divisor}`,
                    answer: correctAnswer,
                    chosen: chosenAnswer,
                    time: questionTimeElapsed,
                    isCorrect: true 
                });

                state.currentQuestionIndex++;
                
                setTimeout(showNextQuestion, 2000); 
            } else {
                state.results.push({
                    question: `${q.dividend} Ã· ${q.divisor}`,
                    answer: correctAnswer,
                    chosen: chosenAnswer,
                    time: Date.now() - state.questionStartTime,
                    isCorrect: false 
                });

                feedback.innerText = "âŒ éŒ¯èª¤ï¼è«‹é‡æ–°é¸æ“‡ã€‚";
                feedback.className = 'feedback wrong';
                
                document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = false);
            }
        }

        function showResultsScreen() {
            stopTimers();
            const totalTimeElapsed = Date.now() - state.startTime;
            
            const correctResults = state.results.filter(r => r.isCorrect === true);
            const totalCorrect = correctResults.length; 

            GAME_HISTORY.push({
                char: state.selectedChar,
                date: new Date().toLocaleDateString('zh-TW'),
                topic: TOPICS[state.selectedTopic].name,
                correct: totalCorrect,
                time: totalTimeElapsed,
                details: correctResults, 
                detailsVisible: false 
            });
            saveHistory();

            document.getElementById('practice-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');

            document.getElementById('result-char').innerText = state.selectedChar;
            document.getElementById('result-topic').innerText = TOPICS[state.selectedTopic].name;
            document.getElementById('result-total-time').innerText = formatTime(totalTimeElapsed);

            const avgTime = (totalTimeElapsed / 1000) / (totalCorrect || 1); 
            let message = "";
            if (totalCorrect < MAX_QUESTIONS) {
                message = "â˜ ï¸ æŒ‘æˆ°å¤±æ•—ï¼è‹¦åŠ›æ€•çˆ†ç‚¸äº†ï¼ä¸‹æ¬¡å°ˆå¿ƒé»ï¼";
            } else if (avgTime < 10) {
                message = "ğŸ”¥ ä½ ç°¡ç›´æ˜¯**æŒ‡ä»¤æ–¹å¡Š**ï¼é€Ÿåº¦å¤ªå¿«äº†ï¼";
            } else if (avgTime < 20) {
                message = "â›ï¸ é€™æ¬¡æŒ–æ˜æ”¶ç©«ä¸éŒ¯ï¼ç¹¼çºŒåŠªåŠ›ï¼";
            } else {
                message = "ğŸ¢ åƒåœ¨**ä¸‹ç•Œ**ç§»å‹•ä¸€æ¨£æ…¢... å°ˆæ³¨é»ï¼Œä¸‹æ¬¡ä¸€å®šå¯ä»¥æ›´å¿«ï¼";
            }
            document.getElementById('result-message').innerText = message;

            const tableBody = document.getElementById('results-table-body');
            tableBody.innerHTML = '';
            correctResults.forEach((r, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).innerText = index + 1;
                row.insertCell(1).innerText = r.question;
                row.insertCell(2).innerText = r.answer;
                row.insertCell(3).innerText = formatTime(r.time);
            });
        }

        function startTimers() {
            state.startTime = Date.now();
            state.totalTimer = setInterval(() => {
                document.getElementById('total-time').innerText = formatTime(Date.now() - state.startTime);
            }, 1000);
            startQuestionTimer();
        }

        function stopTimers() {
            clearInterval(state.totalTimer);
            clearInterval(state.questionTimer);
        }

        function startQuestionTimer() {
            state.questionStartTime = Date.now();
            clearInterval(state.questionTimer);
            state.questionTimer = setInterval(() => {
                document.getElementById('question-time').innerText = formatTime(Date.now() - state.questionStartTime);
            }, 100);
        }


        // --- äº‹ä»¶ç›£è½å™¨è¨­å®š ---

        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            updateStatsDisplay(); 
            checkReady(); 

            document.querySelectorAll('.char-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.char-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    
                    state.selectedChar = e.target.dataset.char;
                    
                    document.getElementById('player-name').innerText = state.selectedChar;
                    document.getElementById('player-avatar').innerText = e.target.dataset.img;
                    
                    updateStatsDisplay(); 
                    checkReady(); 
                });
            });

            document.querySelectorAll('.topic-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.topic-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');

                    state.selectedTopic = e.target.dataset.topicId;
                    checkReady(); 
                });
            });

            document.getElementById('start-game-btn').addEventListener('click', startGame);
            
            document.getElementById('view-history-btn').addEventListener('click', () => {
                const historyArea = document.getElementById('history-area');
                if (historyArea.classList.contains('hidden')) {
                    displayHistory(state.selectedChar);
                } else {
                    historyArea.classList.add('hidden');
                }
            });

            document.getElementById('restart-btn').addEventListener('click', () => {
                document.getElementById('results-screen').classList.add('hidden');
                document.getElementById('selection-screen').classList.remove('hidden');
                
                state.selectedChar = null;
                state.selectedTopic = null;
                
                document.getElementById('player-name').innerText = 'æœªé¸æ“‡';
                document.querySelectorAll('.block-button').forEach(btn => btn.classList.remove('selected'));
                document.getElementById('player-avatar').innerText = '?'; // é‡è¨­é ­åƒ
                
                checkReady(); 
            });
        });
    </script>
</body>
</html>